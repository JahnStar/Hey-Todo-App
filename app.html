<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hey Todos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-white">
    <div class="h-screen flex flex-col items-center justify-center mt-8">
      <div class="bg-blue-50 shadow-md rounded px-8 pt-6 py-8 mb-4">
        <h1 class="block text-grey-800 text-md font-bold mb-2">Welcome, $TITLE_USER</h1>
        <br>
        <div class="flex">
          <button
          class="bg-red-500 hover:bg-red-800 text-white font-bold ml-2 py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            id="logout"
            type="submit"
            style="width:100%; margin-left: 0;"
          >
            Logout
          </button>
        </div> 
        <br>
        <h1 class="block text-grey-800 text-md font-bold mb-2">Todos</h2>
        <div class="flex">
          <input
            class="shadow appearance-none border rounded w-full py-2 px-3 text-grey-800 leading-tight focus:outline-none focus:shadow-outline"
            type="text"
            name="name"
            placeholder="A new todo"
          />
          <button
            class="bg-blue-500 hover:bg-blue-800 text-white font-bold ml-2 py-2 px-4 rounded focus:outline-none focus:shadow-outline"
            id="create"
            type="submit"
          >
            Create
          </button>
        </div>
        <div class="mt-4" id="todos"></div>
        <div class="flex">
          <button class="bg-green-500 hover:bg-green-800 text-white font-bold ml-2 py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="save" type="submit" style="width:100%; margin-left: 0;">
            Save
          </button>
        </div>
      </div>
    </div>
  </body>

  <script>
    window.todos = $TODOS

    var updateTodos = function () {
      fetch('/', {
        method: 'PUT',
        body: JSON.stringify({ data: { todos: window.todos } })
      }).then(async function(response){
        const response_data = await response.json();
        if (response_data.message) alert(response_data.message);
      });
    };

    var completeTodo = function (evt) {
      var checkbox = evt.target;
      var todoElement = checkbox.parentNode;
      var newTodoSet = [].concat(window.todos);
      var todo = newTodoSet.find(t => t.id == todoElement.dataset.todo);
      todo.completed = !todo.completed;
      window.todos = newTodoSet;
    };

    var populateTodos = function () {
      var todoContainer = document.querySelector('#todos');
      todoContainer.innerHTML = null;

      window.todos.forEach(todo => {
        var el = document.createElement('div');
        el.className = 'border-t py-4';
        el.dataset.todo = todo.id;

        var name = document.createElement('span');
        name.className = todo.completed ? 'line-through' : '';
        name.textContent = todo.name;

        var checkbox = document.createElement('input');
        checkbox.className = 'mx-4';
        checkbox.type = 'checkbox';
        checkbox.checked = todo.completed ? 1 : 0;
        checkbox.addEventListener('click', completeTodo);

        el.appendChild(checkbox);
        el.appendChild(name);
        todoContainer.appendChild(el);
      });
    };

    populateTodos();

    var createTodo = function () {
      var input = document.querySelector('input[name=name]');
      if (input.value.length) {
        window.todos = [].concat(todos, {
          id: `${window.todos.length + 1}`,
          name: input.value,
          completed: false
        });
        input.value = '';
        populateTodos();
      }
    };

    var logout = function() { window.location.href = `/logout`; };

    document.querySelector('#save').addEventListener('click', updateTodos);
    document.querySelector('#logout').addEventListener('click', logout);
    document.querySelector('#create').addEventListener('click', createTodo);
  </script>
</html> 